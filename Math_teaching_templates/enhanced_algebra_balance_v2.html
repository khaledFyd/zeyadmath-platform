<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Algebra Balance Scale - Two-Step Equations</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #2196f3;
            --primary-blue-dark: #1976d2;
            --success-green: #4caf50;
            --success-green-dark: #388e3c;
            --danger-red: #f44336;
            --danger-red-dark: #d32f2f;
            --warning-orange: #ff9800;
            --warning-orange-dark: #f57c00;
            --purple: #9c27b0;
            --purple-dark: #7b1fa2;
            --gray: #9e9e9e;
            --gray-dark: #616161;
            --dark-gray: #455a64;
            --light-gray: #f5f5f5;
            --border-radius: 5px;
            --box-shadow: 0 3px 6px rgba(0,0,0,0.16);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #f1f8e9 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            font-size: clamp(24px, 5vw, 32px);
            font-weight: 600;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .xp-display {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: clamp(16px, 3vw, 18px);
            font-weight: 500;
            transition: transform 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .xp-display.pulse {
            animation: pulse 0.5s ease;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            background: var(--light-gray);
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
        }

        .tabs::-webkit-scrollbar {
            height: 4px;
        }

        .tabs::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .tabs::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 2px;
        }

        .tab {
            flex: 1;
            min-width: 120px;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            background: none;
            border: none;
            font-size: clamp(14px, 2.5vw, 16px);
            font-weight: 500;
            color: #666;
            transition: var(--transition);
            position: relative;
            white-space: nowrap;
        }

        .tab:hover {
            background: #e0e0e0;
            color: #333;
        }

        .tab.active {
            background: white;
            color: var(--primary-blue);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-blue);
            animation: slideIn 0.3s ease;
        }

        /* Tab Content */
        .tab-content {
            padding: clamp(20px, 3vw, 30px);
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: scaleX(0); }
            to { transform: scaleX(1); }
        }

        /* Balance Scale Styles */
        .balance-wrapper {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .balance-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            margin: 20px auto;
            height: 300px;
            position: relative;
            max-width: 400px;
        }

        .base {
            width: 120px;
            height: 40px;
            background: linear-gradient(135deg, var(--dark-gray) 0%, #37474f 100%);
            border-radius: 10px 10px 5px 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
        }

        .base::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 10%;
            right: 10%;
            height: 5px;
            background: rgba(0,0,0,0.2);
            border-radius: 50%;
            filter: blur(5px);
        }

        .pole {
            width: 10px;
            height: 140px;
            background: linear-gradient(180deg, var(--dark-gray) 0%, #37474f 100%);
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 2px 0 4px rgba(0,0,0,0.2);
        }

        .arm {
            width: 400px;
            height: 6px;
            background: linear-gradient(90deg, #37474f 0%, var(--dark-gray) 50%, #37474f 100%);
            position: absolute;
            bottom: 180px;
            left: 50%;
            transform-origin: center;
            transform: translateX(-50%) rotate(0deg);
            transition: transform 0.8s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .arm.balanced {
            transform: translateX(-50%) rotate(0deg) !important;
        }

        .arm.animating {
            animation: balanceAnimation 2.4s ease-in-out;
        }

        @keyframes balanceAnimation {
            0% { transform: translateX(-50%) rotate(0deg); }
            20% { transform: translateX(-50%) rotate(-6deg); }
            40% { transform: translateX(-50%) rotate(6deg); }
            60% { transform: translateX(-50%) rotate(-3deg); }
            80% { transform: translateX(-50%) rotate(3deg); }
            100% { transform: translateX(-50%) rotate(0deg); }
        }

        .string {
            width: 1px;
            height: 50px;
            background: #666;
            position: absolute;
            top: 6px;
        }

        .string.left1 { left: 55px; }
        .string.left2 { left: 105px; }
        .string.right1 { right: 55px; }
        .string.right2 { right: 105px; }

        .pan {
            width: 160px;
            height: 8px;
            background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%);
            border-radius: 4px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            position: absolute;
            top: 56px;
        }

        .pan.left { left: 35px; }
        .pan.right { right: 35px; }

        .block-container {
            width: 160px;
            min-height: 80px;
            position: absolute;
            bottom: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            align-items: flex-end;
            padding: 8px;
        }

        .block-container.left { left: 35px; }
        .block-container.right { right: 35px; }

        /* Enhanced Block Styles */
        .block {
            min-width: 80px;
            width: auto;
            height: 70px;
            padding: 0 16px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 28px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
            position: relative;
            transition: var(--transition);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            cursor: pointer;
            user-select: none;
        }

        .block:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 5px 10px rgba(0,0,0,0.3);
        }

        .block.clickable {
            border: 2px solid rgba(255,255,255,0.5);
            animation: glow 2s ease-in-out infinite alternate;
        }

        .block.x {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 100%);
        }

        .block.positive {
            background: linear-gradient(135deg, var(--success-green) 0%, var(--success-green-dark) 100%);
        }

        .block.negative {
            background: linear-gradient(135deg, var(--danger-red) 0%, var(--danger-red-dark) 100%);
        }

        .block.zero {
            background: linear-gradient(135deg, var(--gray) 0%, var(--gray-dark) 100%);
        }

        .block.division {
            background: linear-gradient(135deg, var(--purple) 0%, var(--purple-dark) 100%);
            width: auto;
            padding: 0 20px;
            font-size: 24px;
            min-width: 100px;
        }

        .block.appearing {
            animation: blockAppear 0.5s ease-out;
        }

        .block.removing {
            animation: blockFade 0.5s ease-out forwards;
        }

        .block.combining {
            animation: combine 0.8s ease-in-out forwards;
        }

        @keyframes blockAppear {
            0% { 
                opacity: 0; 
                transform: scale(0) rotate(180deg); 
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.2) rotate(90deg); 
            }
            100% { 
                opacity: 1; 
                transform: scale(1) rotate(0deg); 
            }
        }

        @keyframes blockFade {
            0% { 
                opacity: 1; 
                transform: scale(1) rotate(0deg); 
            }
            50% {
                opacity: 0.5;
                transform: scale(1.1) rotate(-90deg);
            }
            100% { 
                opacity: 0; 
                transform: scale(0) rotate(-180deg); 
            }
        }

        @keyframes combine {
            0% { transform: scale(1); }
            50% { transform: scale(1.3) rotate(180deg); opacity: 0.7; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        @keyframes glow {
            from { box-shadow: 0 0 10px var(--warning-orange); }
            to { box-shadow: 0 0 20px var(--warning-orange), 0 0 30px var(--warning-orange); }
        }

        /* Interactive Elements */
        .operation-selector {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: var(--box-shadow);
            text-align: center;
        }

        .operation-selector h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }

        .dropdown {
            position: relative;
            display: inline-block;
            margin: 10px;
        }

        .dropdown select {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: var(--transition);
            min-width: 150px;
        }

        .dropdown select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(33,150,243,0.2);
        }

        .dropdown select:hover {
            border-color: var(--primary-blue);
        }

        /* Step Indicator */
        .step-indicator {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid var(--warning-orange);
        }

        .step-indicator h4 {
            color: var(--warning-orange-dark);
            margin-bottom: 10px;
            font-size: 18px;
        }

        .step-indicator p {
            color: #333;
            font-size: 16px;
            line-height: 1.5;
        }

        /* Balance Info Display */
        .balance-info {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .balance-info .equation {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-blue);
            margin-bottom: 10px;
        }

        .balance-info .current-step {
            font-size: 18px;
            font-weight: bold;
            color: var(--warning-orange);
            margin-bottom: 10px;
            padding: 8px 16px;
            background: #fff3e0;
            border-radius: 20px;
            display: inline-block;
        }

        .balance-info .status {
            margin-top: 10px;
            font-weight: bold;
            color: var(--success-green);
        }

        /* Button Styles */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: clamp(14px, 2.5vw, 16px);
            font-weight: 500;
            transition: var(--transition);
            margin: 5px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc !important;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
            opacity: 0.6;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-green) 0%, var(--success-green-dark) 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-orange) 0%, var(--warning-orange-dark) 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-red) 0%, var(--danger-red-dark) 100%);
        }

        /* Tutorial Navigation */
        .tutorial-nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .tutorial-btn {
            padding: 12px 20px;
            border: none;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 100%);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: clamp(14px, 2.5vw, 16px);
            font-weight: 500;
            transition: var(--transition);
            min-height: 44px;
            box-shadow: 0 3px 6px rgba(33,150,243,0.3);
        }

        .tutorial-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33,150,243,0.4);
        }

        .tutorial-btn:disabled {
            background: linear-gradient(135deg, #ccc 0%, #999 100%);
            cursor: not-allowed;
        }

        /* Steps and Feedback */
        .steps {
            background: var(--light-gray);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .step {
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 8px;
            border-left: 4px solid var(--primary-blue);
            animation: slideInLeft 0.5s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        @keyframes slideInLeft {
            from { 
                opacity: 0; 
                transform: translateX(-20px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }

        /* Grid Layouts */
        .examples-grid, .revision-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .example-card, .revision-card, .problem-card {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .example-card::before, .revision-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-blue), var(--success-green), var(--warning-orange));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .example-card:hover::before, .revision-card:hover::before {
            transform: scaleX(1);
        }

        .example-card:hover, .revision-card:hover, .problem-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        /* Operation Icons */
        .operation-icons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
            flex-wrap: wrap;
        }

        .op-icon {
            width: 50px;
            height: 50px;
            border: 2px solid #ddd;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: var(--transition);
            background: white;
            position: relative;
        }

        .op-icon::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 10px;
            background: linear-gradient(45deg, var(--primary-blue), var(--success-green));
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s ease;
        }

        .op-icon:hover {
            border-color: transparent;
            transform: scale(1.1);
        }

        .op-icon:hover::after {
            opacity: 1;
        }

        .op-icon.selected {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
            transform: scale(1.1);
        }
        .difficulty {
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 500;
            display: inline-block;
        }

        .difficulty.easy {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .difficulty.medium {
            background: #fff3e0;
            color: #ef6c00;
        }

        .difficulty.hard {
            background: #ffebee;
            color: #c62828;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 10px;
            }

            header {
                padding: 15px;
                text-align: center;
            }

            .balance-container {
                transform: scale(0.85);
                margin: 20px auto;
                height: 250px;
            }

            .balance-info {
                font-size: 14px;
            }

            .balance-info .equation {
                font-size: 18px;
            }

            .operation-icons {
                gap: 8px;
            }

            .op-icon {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }

            .examples-grid, .revision-grid {
                grid-template-columns: 1fr;
            }

            .tutorial-nav {
                flex-direction: column;
                align-items: stretch;
            }

            .tutorial-btn {
                width: 100%;
                text-align: center;
            }

            .tutorial-nav {
                flex-direction: column;
                align-items: stretch;
            }

            .tutorial-btn {
                width: 100%;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .balance-container {
                transform: scale(0.7);
                height: 220px;
            }

            .tabs {
                justify-content: flex-start;
            }

            .tab {
                flex: 0 0 auto;
                padding: 12px 16px;
            }

            .example-card, .revision-card, .problem-card {
                padding: 15px;
            }

            .arm {
                width: 350px;
            }

            .pan {
                width: 140px;
            }

            .block-container {
                width: 140px;
            }

            .block {
                width: 30px;
                height: 30px;
                font-size: 12px;
            }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .mt-1 { margin-top: 10px; }
        .mt-2 { margin-top: 20px; }
        .mb-1 { margin-bottom: 10px; }
        .mb-2 { margin-bottom: 20px; }
        .gap-1 { gap: 10px; }
        .gap-2 { gap: 20px; }

        /* Achievement Toast */
        .achievement {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            font-size: 18px;
            font-weight: bold;
            z-index: 10000;
            animation: slideInRight 0.5s ease, slideOutRight 0.5s ease 3s forwards;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Animation Effects for Examples */
        .operation-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, var(--danger-red) 0%, var(--danger-red-dark) 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            z-index: 100;
            box-shadow: 0 5px 20px rgba(244, 67, 54, 0.4);
            animation: operationPulse 2s ease-in-out;
        }

        @keyframes operationPulse {
            0% { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(0.5); 
            }
            30% { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1.1); 
            }
            70% { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1); 
            }
            100% { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(0.8); 
            }
        }

        .flare-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, #ffd700, #ffed4e, transparent);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: flareExplosion 1.5s ease-out;
            z-index: 99;
            pointer-events: none;
        }

        @keyframes flareExplosion {
            0% {
                width: 20px;
                height: 20px;
                opacity: 1;
            }
            50% {
                width: 150px;
                height: 150px;
                opacity: 0.8;
            }
            100% {
                width: 300px;
                height: 300px;
                opacity: 0;
            }
        }

        .balance-shake {
            animation: balanceShake 0.6s ease-in-out;
        }

        @keyframes balanceShake {
            0%, 100% { transform: translateX(-50%) rotate(0deg); }
            25% { transform: translateX(-50%) rotate(-2deg); }
            75% { transform: translateX(-50%) rotate(2deg); }
        }

        .block-highlight {
            animation: blockHighlight 1s ease-in-out;
        }

        @keyframes blockHighlight {
            0%, 100% { 
                box-shadow: 0 3px 6px rgba(0,0,0,0.2);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 20px var(--warning-orange), 0 0 40px var(--warning-orange);
                transform: scale(1.05);
            }
        }

        /* Balance Badge */
        .balance-badge {
            display: inline-block;
            background: var(--success-green);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🧮 Enhanced Algebra Balance Scale <span class="balance-badge">Two-Step Equations ⚖️</span></h1>
            <div class="xp-display" id="xp-display">
                <span>⭐ XP: </span><span id="xp-value">0</span>
            </div>
        </header>

        <nav class="tabs" role="tablist" aria-label="Main navigation">
            <button class="tab active" role="tab" aria-selected="true" aria-controls="tutorial" onclick="switchTab('tutorial')">
                📚 Tutorial
            </button>
            <button class="tab" role="tab" aria-selected="false" aria-controls="examples" onclick="switchTab('examples')">
                🎯 Examples
            </button>
            <button class="tab" role="tab" aria-selected="false" aria-controls="worksheet" onclick="switchTab('worksheet')">
                ✏️ Worksheet
            </button>
            <button class="tab" role="tab" aria-selected="false" aria-controls="revision" onclick="switchTab('revision')">
                📋 Revision
            </button>
        </nav>

        <!-- Tutorial Tab -->
        <div id="tutorial" class="tab-content active" role="tabpanel" aria-labelledby="tutorial-tab">
            <h2>Learn Two-Step Equations with Interactive Balance</h2>
            <p class="text-center mb-2">
                <strong>🔑 Key Principle:</strong> Click blocks to change signs • Use dropdowns to select operations • Watch the magic happen!
            </p>
            
            <div class="tutorial-nav">
                <button class="tutorial-btn" onclick="loadTutorial(0)">2x + 5 = 15</button>
                <button class="tutorial-btn" onclick="loadTutorial(1)">x/2 + 3 = 8</button>
                <button class="tutorial-btn" onclick="loadTutorial(2)">x/3 - 2 = -6</button>
            </div>

            <div id="tutorial-content">
                <h3 id="tutorial-title" class="text-center">Loading...</h3>
                
                <div class="step-indicator" id="tutorial-step-indicator">
                    <h4>Step 1</h4>
                    <p id="tutorial-instruction">Click the highlighted blocks to change their signs, then select an operation.</p>
                </div>

                <div class="balance-wrapper">
                    <div class="balance-container">
                        <div class="base"></div>
                        <div class="pole"></div>
                        <div class="arm balanced" id="tutorial-arm">
                            <div class="string left1"></div>
                            <div class="string left2"></div>
                            <div class="string right1"></div>
                            <div class="string right2"></div>
                            <div class="pan left"></div>
                            <div class="pan right"></div>
                            <div class="block-container left" id="tutorial-left"></div>
                            <div class="block-container right" id="tutorial-right"></div>
                        </div>
                    </div>

                    <div class="balance-info" id="tutorial-balance-info">
                        <div class="equation" id="tutorial-equation">2x + 5 = 15</div>
                        <div class="current-step" id="tutorial-current-step">Step 1: What should we do to find x?</div>
                        <div class="status">⚖️ Balance shows equation state</div>
                    </div>
                </div>

                <div class="operation-selector" id="tutorial-operation-selector">
                    <h4>Q1) What should we do to find the X?</h4>
                    <div class="dropdown">
                        <select id="tutorial-operation" onchange="handleOperationSelection()">
                            <option value="">Choose operation...</option>
                            <option value="add">Add</option>
                            <option value="subtract">Subtract</option>
                            <option value="multiply">Multiply</option>
                            <option value="divide">Divide</option>
                        </select>
                    </div>
                </div>

                <div class="steps" id="tutorial-steps"></div>

                <div class="tutorial-nav">
                    <button class="btn btn-primary" id="prev-step" onclick="prevStep()" disabled>
                        ⬅️ Previous
                    </button>
                    <button class="btn btn-primary" id="next-step" onclick="nextStep()" disabled>
                        Next ➡️
                    </button>
                    <button class="btn btn-warning" onclick="resetTutorial()">
                        🔄 Reset
                    </button>
                </div>
            </div>
        </div>

        <!-- Examples Tab -->
        <div id="examples" class="tab-content" role="tabpanel" aria-labelledby="examples-tab">
            <h2>Interactive Examples</h2>
            <p class="text-center mb-2">
                Try solving these step-by-step! Click blocks to invert signs and watch the automatic combining. ✨
            </p>
            <div class="examples-grid" id="examples-grid"></div>
        </div>

        <!-- Worksheet Tab -->
        <div id="worksheet" class="tab-content" role="tabpanel" aria-labelledby="worksheet-tab">
            <h2>Practice Problems</h2>
            <p class="text-center mb-2">
                Interactive problem solving! Click blocks, select operations, and earn XP! 🏆
            </p>
            
            <div class="progress-container" style="background: #e0e0e0; border-radius: 10px; height: 24px; overflow: hidden; margin: 20px 0; position: relative; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                <div class="progress-bar" id="progress-bar" style="height: 100%; background: linear-gradient(135deg, var(--success-green) 0%, var(--success-green-dark) 100%); transition: width 0.5s ease; border-radius: 10px; width: 0%;"></div>
            </div>
            <p class="progress-text text-center">
                <span id="progress-text">0 of 9 problems completed</span>
            </p>
            
            <section>
                <h3>🟡 Two-Step Equations (25 XP each)</h3>
                <div id="medium-problems"></div>
            </section>
            
            <section>
                <h3>🔴 Advanced Two-Step (35-40 XP each)</h3>
                <div id="hard-problems"></div>
            </section>
        </div>

        <!-- Revision Tab -->
        <div id="revision" class="tab-content" role="tabpanel" aria-labelledby="revision-tab">
            <h2>Two-Step Equations Reference</h2>
            <p class="text-center mb-2">
                Master the art of solving two-step equations! 📖
            </p>
            
            <div class="revision-grid">
                <div class="revision-card" style="border-color: var(--primary-blue);">
                    <h3>🎯 Two-Step Strategy</h3>
                    <p><strong>The Golden Rule:</strong> Undo operations in reverse order!</p>
                    <div class="text-center mt-2 mb-2">
                        <div style="display: inline-block; padding: 15px 30px; background: #e3f2fd; border-radius: 25px; font-size: 18px; font-weight: bold;">
                            1️⃣ Undo Addition/Subtraction<br>
                            2️⃣ Undo Multiplication/Division
                        </div>
                    </div>
                    <p>For 2x + 5 = 15: First subtract 5, then divide by 2! ⚖️</p>
                </div>

                <div class="revision-card" style="border-color: var(--success-green);">
                    <h3>🔄 Interactive Features</h3>
                    <div style="display: flex; flex-direction: column; gap: 12px; margin: 15px 0;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="block positive" style="position: static; cursor: pointer; min-width: 80px; padding: 0 16px; height: 70px; font-size: 28px;">+5</div>
                            <span>👆 Click to change to</span>
                            <div class="block negative" style="position: static; min-width: 80px; padding: 0 16px; height: 70px; font-size: 28px;">-5</div>
                        </div>
                        <div style="background: #e8f5e9; padding: 12px; border-radius: 8px;">
                            <strong>Auto-Combine:</strong> When you add opposite signs, they automatically cancel out!
                        </div>
                        <div style="background: #e3f2fd; padding: 12px; border-radius: 8px;">
                            <strong>Dropdown Menus:</strong> Select the correct operation to proceed to the next step.
                        </div>
                    </div>
                </div>

                <div class="revision-card" style="border-color: var(--warning-orange);">
                    <h3>📊 Example Walkthrough</h3>
                    <h4>Solving 2x + 5 = 15:</h4>
                    <div style="margin: 15px 0; padding: 15px; background: #fff3e0; border-radius: 10px;">
                        <div style="margin-bottom: 10px;"><strong>Step 1:</strong> Subtract 5 from both sides</div>
                        <div style="margin-bottom: 10px; padding-left: 20px;">2x + 5 - 5 = 15 - 5</div>
                        <div style="margin-bottom: 10px; padding-left: 20px;">2x = 10</div>
                        <div style="margin-bottom: 10px;"><strong>Step 2:</strong> Divide both sides by 2</div>
                        <div style="margin-bottom: 10px; padding-left: 20px;">2x ÷ 2 = 10 ÷ 2</div>
                        <div style="padding-left: 20px; color: var(--success-green); font-weight: bold;">x = 5 ✓</div>
                    </div>
                </div>

                <div class="revision-card" style="border-color: var(--purple);">
                    <h3>🧮 Equation Types</h3>
                    <h4>Common Two-Step Patterns:</h4>
                    <ul style="margin: 10px 0 15px 20px; line-height: 1.8;">
                        <li><strong>ax + b = c:</strong> 2x + 5 = 15</li>
                        <li><strong>ax - b = c:</strong> 3x - 6 = 9</li>
                        <li><strong>x/a + b = c:</strong> x/2 + 3 = 8</li>
                        <li><strong>x/a - b = c:</strong> x/3 - 2 = -6</li>
                    </ul>
                    <div style="background: #f3e5f5; padding: 12px; border-radius: 8px;">
                        <strong>Pro Tip:</strong> Always check your answer by substituting back into the original equation!
                    </div>
                </div>

                <div class="revision-card" style="border-color: var(--danger-red);">
                    <h3>⚠️ Common Mistakes</h3>
                    <ol style="margin: 15px 0 0 20px; line-height: 2;">
                        <li><strong>Wrong Order:</strong> Don't multiply/divide first!</li>
                        <li><strong>Sign Errors:</strong> Be careful with negative numbers</li>
                        <li><strong>Forgetting Both Sides:</strong> Always apply operations to both sides</li>
                        <li><strong>Not Checking:</strong> Always verify your answer</li>
                    </ol>
                    <div style="background: #ffebee; padding: 12px; border-radius: 8px; margin-top: 15px;">
                        <strong>Remember:</strong> The balance scale must always stay balanced! ⚖️
                    </div>
                </div>

                <div class="revision-card" style="border-color: var(--gray);">
                    <h3>💡 Success Tips</h3>
                    <ol style="margin: 15px 0 0 20px; line-height: 2;">
                        <li><strong>Visualize:</strong> Use the balance scale to understand what's happening</li>
                        <li><strong>Take Your Time:</strong> Rushing leads to mistakes</li>
                        <li><strong>Practice:</strong> The more you do, the easier it gets</li>
                        <li><strong>Check Your Work:</strong> Substitute your answer back into the original equation</li>
                        <li><strong>Ask for Help:</strong> Don't hesitate to use hints when stuck</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Operation Modal -->
    <div id="operation-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-content">
            <h3 id="modal-title">Apply Operation</h3>
            <p id="modal-instruction">Enter the value to apply:</p>
            <div>
                <span id="modal-operation"></span>
                <input type="number" id="modal-value" autofocus aria-label="Operation value" />
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="applyWorksheetOperation()">✅ Apply</button>
                <button class="btn btn-danger" onclick="closeModal()">❌ Cancel</button>
            </div>
        </div>
    </div>

    <script>
        'use strict';

        let currentWorksheetProblem = null;
        const problemSteps = {};
        const problemAttempts = {};

        // Global variables
        let currentXP = 0;
        let currentTutorial = 0;
        let currentStep = 0;
        let problemsCompleted = 0;
        const totalProblems = 9;
        let currentProblem = null;
        let tutorialState = {
            step: 0,
            clickableBlocks: [],
            operationSelected: false,
            equation: '',
            leftBlocks: [],
            rightBlocks: []
        };

        // Tutorial data for two-step equations from the storyboard
        const tutorials = [
            {
                title: "Two-Step: 2x + 5 = 15",
                equation: "2x + 5 = 15",
                solution: 5,
                steps: [
                    {
                        instruction: "Q1) What should we do to find the X? First, we need to remove the +5. Click on +5 block to invert it, then select 'Subtract'.",
                        leftBlocks: ["2x", "+5"],
                        rightBlocks: ["+15"],
                        clickableBlocks: ["left-1"],
                        expectedOperation: "subtract",
                        nextEquation: "2x = 10"
                    },
                    {
                        instruction: "Q1) What should we do next? Now we have 2x = 10. We need to divide both sides by 2 to isolate x.",
                        leftBlocks: ["2x"],
                        rightBlocks: ["+10"],
                        clickableBlocks: [],
                        expectedOperation: "divide",
                        nextEquation: "x = 5"
                    },
                    {
                        instruction: "Perfect! We found that x = 5. Let's verify: 2(5) + 5 = 10 + 5 = 15 ✓",
                        leftBlocks: ["x"],
                        rightBlocks: ["+5"],
                        clickableBlocks: [],
                        expectedOperation: null,
                        nextEquation: "x = 5"
                    }
                ]
            },
            {
                title: "Two-Step: x/2 + 3 = 8",
                equation: "x/2 + 3 = 8",
                solution: 10,
                steps: [
                    {
                        instruction: "Q1) What should we do to find the X? First, remove the +3. Click on +3 block to invert it, then select 'Subtract'.",
                        leftBlocks: ["x ÷ 2", "+3"],
                        rightBlocks: ["+8"],
                        clickableBlocks: ["left-1"],
                        expectedOperation: "subtract",
                        nextEquation: "x/2 = 5"
                    },
                    {
                        instruction: "Q1) What should we do next? Now we have x/2 = 5. Multiply both sides by 2 to isolate x.",
                        leftBlocks: ["x ÷ 2"],
                        rightBlocks: ["+5"],
                        clickableBlocks: [],
                        expectedOperation: "multiply",
                        nextEquation: "x = 10"
                    },
                    {
                        instruction: "Excellent! We found that x = 10. Let's verify: 10/2 + 3 = 5 + 3 = 8 ✓",
                        leftBlocks: ["x"],
                        rightBlocks: ["+10"],
                        clickableBlocks: [],
                        expectedOperation: null,
                        nextEquation: "x = 10"
                    }
                ]
            },
            {
                title: "Two-Step: x/3 - 2 = -6",
                equation: "x/3 - 2 = -6",
                solution: -12,
                steps: [
                    {
                        instruction: "Q1) What should we do to find the X? First, remove the -2. Click on -2 block to invert it, then select 'Add'.",
                        leftBlocks: ["x ÷ 3", "-2"],
                        rightBlocks: ["-6"],
                        clickableBlocks: ["left-1"],
                        expectedOperation: "add",
                        nextEquation: "x/3 = -4"
                    },
                    {
                        instruction: "Q1) What should we do next? Now we have x/3 = -4. Multiply both sides by 3 to isolate x.",
                        leftBlocks: ["x ÷ 3"],
                        rightBlocks: ["-4"],
                        clickableBlocks: [],
                        expectedOperation: "multiply",
                        nextEquation: "x = -12"
                    },
                    {
                        instruction: "Great work! We found that x = -12. Let's verify: -12/3 - 2 = -4 - 2 = -6 ✓",
                        leftBlocks: ["x"],
                        rightBlocks: ["-12"],
                        clickableBlocks: [],
                        expectedOperation: null,
                        nextEquation: "x = -12"
                    }
                ]
            }
        ];

        // Examples data
        const examples = [
            { 
                equation: "3x + 4 = 13", 
                difficulty: "medium", 
                xp: 25, 
                answer: 3,
                steps: ["Subtract 4 from both sides", "Divide by 3"],
                hint: "First remove the +4, then deal with the 3x."
            },
            { 
                equation: "2x - 6 = 8", 
                difficulty: "medium", 
                xp: 25, 
                answer: 7,
                steps: ["Add 6 to both sides", "Divide by 2"],
                hint: "First remove the -6, then deal with the 2x."
            },
            { 
                equation: "x/4 + 5 = 8", 
                difficulty: "medium", 
                xp: 25, 
                answer: 12,
                steps: ["Subtract 5 from both sides", "Multiply by 4"],
                hint: "First remove the +5, then deal with the division."
            },
            { 
                equation: "5x - 3 = 17", 
                difficulty: "hard", 
                xp: 35, 
                answer: 4,
                steps: ["Add 3 to both sides", "Divide by 5"],
                hint: "Remember: undo operations in reverse order!"
            },
            { 
                equation: "x/3 + 8 = 2", 
                difficulty: "hard", 
                xp: 35, 
                answer: -18,
                steps: ["Subtract 8 from both sides", "Multiply by 3"],
                hint: "Be careful with negative results!"
            },
            { 
                equation: "4x + 7 = -5", 
                difficulty: "hard", 
                xp: 40, 
                answer: -3,
                steps: ["Subtract 7 from both sides", "Divide by 4"],
                hint: "Working with negatives requires extra care."
            }
        ];

        // Worksheet problems
        const worksheetProblems = {
            medium: [
                { equation: "2x + 3 = 11", answer: 4, xp: 25 },
                { equation: "3x - 5 = 10", answer: 5, xp: 25 },
                { equation: "x/2 + 4 = 7", answer: 6, xp: 25 }
            ],
            hard: [
                { equation: "4x + 6 = 22", answer: 4, xp: 35 },
                { equation: "5x - 8 = 12", answer: 4, xp: 35 },
                { equation: "x/3 - 1 = 2", answer: 9, xp: 35 },
                { equation: "6x + 9 = -3", answer: -2, xp: 40 },
                { equation: "x/4 - 3 = -5", answer: -8, xp: 40 },
                { equation: "7x - 11 = 3", answer: 2, xp: 40 }
            ]
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                loadTutorial(0);
                generateExamples();
                generateWorksheetProblems();
                updateProgressDisplay();
            }, 100);
        });

        // Tab switching
        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
            });
            contents.forEach(content => content.classList.remove('active'));
            
            const tabIndex = ['tutorial', 'examples', 'worksheet', 'revision'].indexOf(tabName);
            if (tabIndex !== -1) {
                tabs[tabIndex].classList.add('active');
                tabs[tabIndex].setAttribute('aria-selected', 'true');
                document.getElementById(tabName).classList.add('active');
            }
        }

        // Tutorial functions
        function loadTutorial(index) {
            currentTutorial = index;
            currentStep = 0;
            const tutorial = tutorials[index];
            
            tutorialState = {
                step: 0,
                clickableBlocks: tutorial.steps[0].clickableBlocks || [],
                operationSelected: false,
                equation: tutorial.equation,
                leftBlocks: [...tutorial.steps[0].leftBlocks],
                rightBlocks: [...tutorial.steps[0].rightBlocks]
            };
            
            document.getElementById('tutorial-title').textContent = tutorial.title;
            document.getElementById('tutorial-equation').textContent = tutorial.equation;
            document.getElementById('tutorial-instruction').textContent = tutorial.steps[0].instruction;
            
            updateTutorialBlocks();
            updateNavigationButtons();
            
            // Reset operation selector
            document.getElementById('tutorial-operation').value = '';
            document.getElementById('next-step').disabled = true;
        }

        function updateTutorialBlocks() {
            const tutorial = tutorials[currentTutorial];
            const currentStepData = tutorial.steps[currentStep];
            
            updateBlocks('tutorial-left', currentStepData.leftBlocks, currentStepData.clickableBlocks?.filter(id => id.startsWith('left')));
            updateBlocks('tutorial-right', currentStepData.rightBlocks, currentStepData.clickableBlocks?.filter(id => id.startsWith('right')));
            
            // Update balance info
            updateTutorialBalance();
            
            // Animate balance
            animateBalance('tutorial-arm');
        }

        function updateTutorialBalance() {
            const tutorial = tutorials[currentTutorial];
            const currentStepData = tutorial.steps[currentStep];
            
            // Update the step instruction display
            document.getElementById('tutorial-current-step').textContent = 
                currentStep < tutorial.steps.length - 1 ? 
                `Step ${currentStep + 1}: ${currentStepData.instruction.split('.')[0]}` :
                'Complete! ✅';
        }

        function updateBlocks(containerId, blocks, clickableIds = []) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Clear existing blocks
            container.innerHTML = '';
            
            blocks.forEach((block, index) => {
                const blockDiv = document.createElement('div');
                blockDiv.className = 'block appearing';
                blockDiv.textContent = block;
                blockDiv.dataset.index = index;
                
                // Set block type and click handler
                if (block === 'x' || block.match(/^\d+x$/)) {
                    blockDiv.classList.add('x');
                } else if (block.includes('÷')) {
                    blockDiv.classList.add('division');
                } else if (block.startsWith('+') || (!block.startsWith('-') && !isNaN(parseInt(block)) && parseInt(block) > 0)) {
                    blockDiv.classList.add('positive');
                } else if (block.startsWith('-') || (!isNaN(parseInt(block)) && parseInt(block) < 0)) {
                    blockDiv.classList.add('negative');
                } else if (block === '0') {
                    blockDiv.classList.add('zero');
                }
                
                // Make clickable if in tutorial and in clickable list
                const blockId = `${containerId.split('-')[1]}-${index}`;
                if (clickableIds && clickableIds.includes(blockId)) {
                    blockDiv.classList.add('clickable');
                    blockDiv.onclick = () => handleBlockClick(blockDiv, containerId, index);
                }
                
                container.appendChild(blockDiv);
                
                // Remove appearing class after animation
                setTimeout(() => {
                    blockDiv.classList.remove('appearing');
                }, 500);
            });
        }

        function handleBlockClick(blockDiv, containerId, index) {
            if (!blockDiv.classList.contains('clickable')) return;
            
            const currentText = blockDiv.textContent;
            let newText = currentText;
            
            // Invert the sign for consolidated numbers
            if (currentText.startsWith('+')) {
                newText = '-' + currentText.substring(1);
                blockDiv.classList.remove('positive');
                blockDiv.classList.add('negative');
            } else if (currentText.startsWith('-')) {
                newText = '+' + currentText.substring(1);
                blockDiv.classList.remove('negative');
                blockDiv.classList.add('positive');
            } else if (!isNaN(parseInt(currentText))) {
                // Handle numbers without explicit + sign
                const num = parseInt(currentText);
                if (num > 0) {
                    newText = '-' + currentText;
                    blockDiv.classList.remove('positive');
                    blockDiv.classList.add('negative');
                } else {
                    newText = '+' + Math.abs(num).toString();
                    blockDiv.classList.remove('negative');
                    blockDiv.classList.add('positive');
                }
            }
            
            blockDiv.textContent = newText;
            blockDiv.classList.add('combining');
            
            // Update the internal state
            const isLeft = containerId.includes('left');
            if (isLeft) {
                tutorialState.leftBlocks[index] = newText;
            } else {
                tutorialState.rightBlocks[index] = newText;
            }
            
            // Remove clickable class
            blockDiv.classList.remove('clickable');
            
            // Check if all required blocks have been clicked
            setTimeout(() => {
                blockDiv.classList.remove('combining');
                checkTutorialProgress();
            }, 800);
        }

        function checkTutorialProgress() {
            const tutorial = tutorials[currentTutorial];
            const currentStepData = tutorial.steps[currentStep];
            
            // Check if all clickable blocks have been clicked (no more clickable blocks visible)
            const clickableBlocks = document.querySelectorAll('#tutorial-left .clickable, #tutorial-right .clickable');
            
            if (clickableBlocks.length === 0 && currentStepData.clickableBlocks.length > 0) {
                // All blocks clicked, now enable operation selection
                document.getElementById('tutorial-instruction').textContent = 
                    "Great! Now select the correct operation from the dropdown.";
            }
        }

        function handleOperationSelection() {
            const selectedOperation = document.getElementById('tutorial-operation').value;
            const tutorial = tutorials[currentTutorial];
            const currentStepData = tutorial.steps[currentStep];
            
            if (!selectedOperation) return;
            
            if (selectedOperation === currentStepData.expectedOperation) {
                // Correct operation
                tutorialState.operationSelected = true;
                document.getElementById('next-step').disabled = false;
                
                showFeedback('Correct! ' + getOperationFeedback(selectedOperation), 'success');
                
                // Auto-combine blocks if needed
                if (currentStepData.clickableBlocks.length > 0) {
                    setTimeout(() => {
                        performAutoCombine();
                    }, 1000);
                }
            } else {
                // Wrong operation
                showFeedback('Try again! Think about what you need to undo first.', 'error');
                document.getElementById('tutorial-operation').value = '';
            }
        }

        function getOperationFeedback(operation) {
            switch(operation) {
                case 'add': return 'Adding will cancel out the subtraction.';
                case 'subtract': return 'Subtracting will cancel out the addition.';
                case 'multiply': return 'Multiplying will cancel out the division.';
                case 'divide': return 'Dividing will cancel out the multiplication.';
                default: return 'Good choice!';
            }
        }

        function performAutoCombine() {
            // Simulate automatic combining of opposite signs
            const leftContainer = document.getElementById('tutorial-left');
            const rightContainer = document.getElementById('tutorial-right');
            
            // Find and remove zero pairs
            removeZeroPairs(leftContainer);
            removeZeroPairs(rightContainer);
            
            // Update balance
            setTimeout(() => {
                animateBalance('tutorial-arm');
            }, 500);
        }

        function removeZeroPairs(container) {
            const blocks = Array.from(container.children);
            const toRemove = [];
            
            for (let i = 0; i < blocks.length; i++) {
                for (let j = i + 1; j < blocks.length; j++) {
                    const block1 = blocks[i];
                    const block2 = blocks[j];
                    
                    if (areZeroPair(block1.textContent, block2.textContent)) {
                        toRemove.push(block1, block2);
                        break;
                    }
                }
                if (toRemove.length > 0) break;
            }
            
            // Remove zero pairs with animation
            toRemove.forEach(block => {
                block.classList.add('removing');
                setTimeout(() => {
                    if (block.parentNode) {
                        block.parentNode.removeChild(block);
                    }
                }, 500);
            });
        }

        function areZeroPair(text1, text2) {
            // Handle +1/-1 pairs
            if ((text1 === '+1' && text2 === '-1') || (text1 === '-1' && text2 === '+1')) {
                return true;
            }
            
            // Handle consolidated number pairs
            if (text1.startsWith('+') && text2.startsWith('-')) {
                const num1 = text1.substring(1);
                const num2 = text2.substring(1);
                return num1 === num2;
            } else if (text1.startsWith('-') && text2.startsWith('+')) {
                const num1 = text1.substring(1);
                const num2 = text2.substring(1);
                return num1 === num2;
            }
            
            // Handle numbers without explicit signs
            const num1 = parseInt(text1);
            const num2 = parseInt(text2);
            if (!isNaN(num1) && !isNaN(num2)) {
                return num1 === -num2;
            }
            
            return false;
        }

        function nextStep() {
            const tutorial = tutorials[currentTutorial];
            if (currentStep < tutorial.steps.length - 1) {
                currentStep++;
                const newStepData = tutorial.steps[currentStep];
                
                // Update the display
                document.getElementById('tutorial-instruction').textContent = newStepData.instruction;
                document.getElementById('tutorial-equation').textContent = newStepData.nextEquation || tutorial.equation;
                
                tutorialState = {
                    step: currentStep,
                    clickableBlocks: newStepData.clickableBlocks || [],
                    operationSelected: false,
                    equation: newStepData.nextEquation || tutorial.equation,
                    leftBlocks: [...newStepData.leftBlocks],
                    rightBlocks: [...newStepData.rightBlocks]
                };
                
                updateTutorialBlocks();
                updateNavigationButtons();
                
                // Reset operation selector
                document.getElementById('tutorial-operation').value = '';
                document.getElementById('next-step').disabled = currentStep >= tutorial.steps.length - 1 || !newStepData.expectedOperation;
                
                // If this is the last step, show completion
                if (currentStep === tutorial.steps.length - 1) {
                    showFeedback('🎉 Tutorial Complete! You solved the equation successfully!', 'success');
                    addXP(50);
                }
            }
        }

        function prevStep() {
            if (currentStep > 0) {
                currentStep--;
                const tutorial = tutorials[currentTutorial];
                const stepData = tutorial.steps[currentStep];
                
                tutorialState = {
                    step: currentStep,
                    clickableBlocks: stepData.clickableBlocks || [],
                    operationSelected: false,
                    equation: currentStep === 0 ? tutorial.equation : tutorial.steps[currentStep - 1].nextEquation || tutorial.equation,
                    leftBlocks: [...stepData.leftBlocks],
                    rightBlocks: [...stepData.rightBlocks]
                };
                
                document.getElementById('tutorial-instruction').textContent = stepData.instruction;
                document.getElementById('tutorial-equation').textContent = tutorialState.equation;
                
                updateTutorialBlocks();
                updateNavigationButtons();
                
                // Reset operation selector
                document.getElementById('tutorial-operation').value = '';
                document.getElementById('next-step').disabled = true;
            }
        }

        function resetTutorial() {
            loadTutorial(currentTutorial);
        }

        function updateNavigationButtons() {
            document.getElementById('prev-step').disabled = currentStep === 0;
            
            const tutorial = tutorials[currentTutorial];
            const isLastStep = currentStep >= tutorial.steps.length - 1;
            const currentStepData = tutorial.steps[currentStep];
            
            document.getElementById('next-step').disabled = 
                !tutorialState.operationSelected && currentStepData.expectedOperation !== null;
        }

        // Animate balance
        function animateBalance(armId) {
            const arm = document.getElementById(armId);
            if (!arm) return;
            
            arm.classList.add('animating');
            
            setTimeout(() => {
                arm.classList.remove('animating');
                arm.classList.add('balanced');
            }, 2400);
        }

        // Examples generation
        function generateExamples() {
            const container = document.getElementById('examples-grid');
            container.innerHTML = '';
            
            examples.forEach((example, index) => {
                const card = document.createElement('div');
                card.className = 'example-card';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>${example.equation}</h3>
                        <span class="difficulty ${example.difficulty}">${example.difficulty.charAt(0).toUpperCase() + example.difficulty.slice(1)} (${example.xp} XP)</span>
                    </div>
                    <div class="balance-wrapper">
                        <div class="balance-container" style="height: 200px; transform: scale(0.7);">
                            <div class="base"></div>
                            <div class="pole"></div>
                            <div class="arm balanced">
                                <div class="string left1"></div>
                                <div class="string left2"></div>
                                <div class="string right1"></div>
                                <div class="string right2"></div>
                                <div class="pan left"></div>
                                <div class="pan right"></div>
                                <div class="block-container left" id="example-left-${index}"></div>
                                <div class="block-container right" id="example-right-${index}"></div>
                            </div>
                        </div>
                        <div class="balance-info">
                            <small>When x = ${example.answer}, the equation balances perfectly! ⚖️</small>
                        </div>
                    </div>
                    <div class="text-center mt-1">
                        <button class="btn btn-primary" onclick="showExampleHint(${index})">💡 Hint</button>
                        <button class="btn btn-success" onclick="showExampleSolution(${index})">🎯 Solution</button>
                    </div>
                    <div id="example-hint-${index}" style="display: none; margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                        <strong>💡 Hint:</strong> ${example.hint}
                    </div>
                    <div id="example-solution-${index}" style="display: none; margin-top: 15px; padding: 15px; background: #e8f5e9; border-radius: 8px;">
                        <strong>🎯 Solution:</strong><br>
                        ${example.steps.map((step, i) => `${i + 1}. ${step}`).join('<br>')}
                        <br><strong>Answer: x = ${example.answer}</strong>
                    </div>
                `;
                container.appendChild(card);
                
                // Setup blocks for the example
                setTimeout(() => {
                    setupExampleBlocks(index, example);
                }, 100 * index);
            });
        }

        function setupExampleBlocks(index, example) {
            const leftBlocks = parseEquationToBlocks(example.equation.split('=')[0].trim());
            const rightBlocks = parseEquationToBlocks(example.equation.split('=')[1].trim());
            
            updateBlocks(`example-left-${index}`, leftBlocks);
            updateBlocks(`example-right-${index}`, rightBlocks);
        }

        function parseEquationToBlocks(side) {
            const blocks = [];
            side = side.replace(/\s/g, '');
            
            if (side.includes('÷')) {
                const divMatch = side.match(/x÷(\d+)/);
                if (divMatch) {
                    blocks.push(`x ÷ ${divMatch[1]}`);
                    const afterDiv = side.split(`x÷${divMatch[1]}`)[1];
                    if (afterDiv) {
                        const addMatch = afterDiv.match(/\+(\d+)/);
                        const subMatch = afterDiv.match(/-(\d+)/);
                        if (addMatch) {
                            const num = parseInt(addMatch[1]);
                            blocks.push(`+${num}`);
                        } else if (subMatch) {
                            const num = parseInt(subMatch[1]);
                            blocks.push(`-${num}`);
                        }
                    }
                }
            } else if (side.includes('x')) {
                const xMatch = side.match(/(\d*)x/);
                if (xMatch) {
                    const coefficient = xMatch[1] ? parseInt(xMatch[1]) : 1;
                    if (coefficient === 1) {
                        blocks.push('x');
                    } else {
                        blocks.push(`${coefficient}x`);
                    }
                }
                
                const afterX = side.split(/\d*x/)[1];
                if (afterX) {
                    const addMatch = afterX.match(/\+(\d+)/);
                    const subMatch = afterX.match(/-(\d+)/);
                    if (addMatch) {
                        const num = parseInt(addMatch[1]);
                        blocks.push(`+${num}`);
                    } else if (subMatch) {
                        const num = parseInt(subMatch[1]);
                        blocks.push(`-${num}`);
                    }
                }
            } else {
                const num = parseInt(side);
                if (!isNaN(num)) {
                    blocks.push(num > 0 ? `+${num}` : `${num}`);
                }
            }
            
            return blocks;
        }

        function showExampleHint(index) {
            const hint = document.getElementById(`example-hint-${index}`);
            hint.style.display = hint.style.display === 'none' ? 'block' : 'none';
        }

        function showExampleSolution(index) {
            const solution = document.getElementById(`example-solution-${index}`);
            solution.style.display = solution.style.display === 'none' ? 'block' : 'none';
        }

        // Worksheet generation
        function generateWorksheetProblems() {
            generateProblemSection('medium', worksheetProblems.medium);
            generateProblemSection('hard', worksheetProblems.hard);
        }

        function generateProblemSection(difficulty, problems) {
            const container = document.getElementById(`${difficulty}-problems`);
            container.innerHTML = '';
            
            problems.forEach((problem, index) => {
                const problemDiv = document.createElement('div');
                problemDiv.className = 'problem-card';
                problemDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4>Problem ${index + 1}: ${problem.equation}</h4>
                        <span class="difficulty ${difficulty}">${problem.xp} XP</span>
                    </div>
                    <div class="balance-wrapper">
                        <div class="balance-container" style="height: 180px; transform: scale(0.6);">
                            <div class="base"></div>
                            <div class="pole"></div>
                            <div class="arm balanced">
                                <div class="string left1"></div>
                                <div class="string left2"></div>
                                <div class="string right1"></div>
                                <div class="string right2"></div>
                                <div class="pan left"></div>
                                <div class="pan right"></div>
                                <div class="block-container left" id="problem-left-${difficulty}-${index}"></div>
                                <div class="block-container right" id="problem-right-${difficulty}-${index}"></div>
                            </div>
                        </div>
                        <div class="balance-info">
                            <small>Solve this two-step equation step by step!</small>
                        </div>
                    </div>
                    <div class="operation-icons">
                        <div class="op-icon" onclick="selectProblemOperation('${difficulty}', ${index}, '+', this)">+</div>
                        <div class="op-icon" onclick="selectProblemOperation('${difficulty}', ${index}, '-', this)">−</div>
                        <div class="op-icon" onclick="selectProblemOperation('${difficulty}', ${index}, '×', this)">×</div>
                        <div class="op-icon" onclick="selectProblemOperation('${difficulty}', ${index}, '÷', this)">÷</div>
                    </div>
                    <div class="step-tracker" id="steps-${difficulty}-${index}"></div>
                    <div class="text-center mt-2">
                        <label for="answer-${difficulty}-${index}">Your answer: x = </label>
                        <input type="number" id="answer-${difficulty}-${index}" style="width: 80px; padding: 8px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; text-align: center;" />
                        <button class="btn btn-primary" onclick="checkWorksheetAnswer('${difficulty}', ${index})">✅ Check</button>
                    </div>
                    <div id="feedback-${difficulty}-${index}" style="margin-top: 15px; display: none;"></div>
                    <div class="text-center mt-1">
                        <button class="btn btn-warning" onclick="showProblemHint('${difficulty}', ${index})">💡 Hint</button>
                        <span style="margin-left: 20px;">Attempts: <span id="attempts-${difficulty}-${index}">0</span></span>
                    </div>
                `;
                container.appendChild(problemDiv);
                
                // Set up blocks
                setTimeout(() => {
                    const leftBlocks = parseEquationToBlocks(problem.equation.split('=')[0].trim());
                    const rightBlocks = parseEquationToBlocks(problem.equation.split('=')[1].trim());
                    updateBlocks(`problem-left-${difficulty}-${index}`, leftBlocks);
                    updateBlocks(`problem-right-${difficulty}-${index}`, rightBlocks);
                }, 100 * index);
            });
        }

        function selectProblemOperation(difficulty, index, operation, element) {
            const problemDiv = element.closest('.problem-card');
            const icons = problemDiv.querySelectorAll('.op-icon');
            icons.forEach(icon => icon.classList.remove('selected'));
            
            element.classList.add('selected');
            
            currentWorksheetProblem = {
                difficulty: difficulty,
                index: index,
                operation: operation,
                equation: worksheetProblems[difficulty][index].equation
            };
            
            showWorksheetModal(operation);
        }

        function showWorksheetModal(operation) {
            const modal = document.getElementById('operation-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalInstruction = document.getElementById('modal-instruction');
            const modalOperation = document.getElementById('modal-operation');
            const modalValue = document.getElementById('modal-value');
            
            let instruction = '';
            let operationText = '';
            let emoji = '';
            
            switch(operation) {
                case '+':
                    instruction = 'What number do you want to add to both sides?';
                    operationText = 'Add';
                    emoji = '➕';
                    break;
                case '-':
                    instruction = 'What number do you want to subtract from both sides?';
                    operationText = 'Subtract';
                    emoji = '➖';
                    break;
                case '×':
                    instruction = 'What number do you want to multiply both sides by?';
                    operationText = 'Multiply by';
                    emoji = '✖️';
                    break;
                case '÷':
                    instruction = 'What number do you want to divide both sides by?';
                    operationText = 'Divide by';
                    emoji = '➗';
                    break;
            }
            
            modalTitle.innerHTML = `${emoji} Apply ${operationText}`;
            modalInstruction.textContent = instruction;
            modalOperation.textContent = operationText + ':';
            modalValue.value = '';
            modalValue.focus();
            
            modal.classList.add('show');
            
            // Handle enter key
            modalValue.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    applyWorksheetOperation();
                }
            };
        }

        function closeModal() {
            const modal = document.getElementById('operation-modal');
            modal.classList.remove('show');
        }

        function applyOperation() {
            // This is for tutorial - rename to avoid conflict
            applyWorksheetOperation();
        }

        function applyWorksheetOperation() {
            const modalValue = document.getElementById('modal-value');
            const value = parseInt(modalValue.value);
            
            if (!value || value === 0) {
                alert('Please enter a valid number (not zero)!');
                return;
            }
            
            closeModal();
            
            if (currentWorksheetProblem) {
                const trackerId = `steps-${currentWorksheetProblem.difficulty}-${currentWorksheetProblem.index}`;
                const tracker = document.getElementById(trackerId);
                tracker.classList.add('show');
                
                const key = `${currentWorksheetProblem.difficulty}-${currentWorksheetProblem.index}`;
                if (!problemSteps[key]) {
                    problemSteps[key] = [];
                }
                
                const step = {
                    operation: currentWorksheetProblem.operation,
                    value: value,
                    equation: currentWorksheetProblem.equation
                };
                problemSteps[key].push(step);
                
                const stepDiv = document.createElement('div');
                stepDiv.className = 'step-item';
                const emoji = currentWorksheetProblem.operation === '+' ? '➕' : 
                             currentWorksheetProblem.operation === '-' ? '➖' : 
                             currentWorksheetProblem.operation === '×' ? '✖️' : '➗';
                stepDiv.innerHTML = `
                    <span>Step ${problemSteps[key].length}: ${emoji} ${currentWorksheetProblem.operation}${value} to both sides</span>
                `;
                tracker.appendChild(stepDiv);
                
                verifyWorksheetStep(currentWorksheetProblem, value, stepDiv);
            }
        }

        function verifyWorksheetStep(problem, value, stepDiv) {
            const originalEquation = worksheetProblems[problem.difficulty][problem.index].equation;
            const key = `${problem.difficulty}-${problem.index}`;
            
            // Simple verification for two-step equations
            const steps = problemSteps[key] || [];
            let isCorrect = false;
            let feedback = '';
            
            // Parse current equation to understand what operation is needed
            const equation = originalEquation;
            const hasAddition = equation.includes('+') && equation.indexOf('+') > equation.indexOf('x');
            const hasSubtraction = equation.includes('-') && equation.indexOf('-') > equation.indexOf('x');
            const hasMultiplication = equation.match(/\d+x/);
            const hasDivision = equation.includes('÷');
            
            if (steps.length === 1) {
                // First step - remove the constant term
                if (hasAddition && problem.operation === '-') {
                    const addValue = parseInt(equation.match(/\+\s*(\d+)/)[1]);
                    isCorrect = value === addValue;
                    if (!isCorrect) feedback = `Try subtracting ${addValue}`;
                } else if (hasSubtraction && problem.operation === '+') {
                    const subValue = parseInt(equation.match(/-\s*(\d+)/)[1]);
                    isCorrect = value === subValue;
                    if (!isCorrect) feedback = `Try adding ${subValue}`;
                } else {
                    isCorrect = false;
                    feedback = 'First, remove the constant term (number without x)';
                }
            } else if (steps.length === 2) {
                // Second step - isolate x
                if (hasMultiplication && problem.operation === '÷') {
                    const coefficient = parseInt(equation.match(/(\d+)x/)[1]);
                    isCorrect = value === coefficient;
                    if (!isCorrect) feedback = `Try dividing by ${coefficient}`;
                } else if (hasDivision && problem.operation === '×') {
                    const divisor = parseInt(equation.match(/÷\s*(\d+)/)[1]);
                    isCorrect = value === divisor;
                    if (!isCorrect) feedback = `Try multiplying by ${divisor}`;
                } else {
                    isCorrect = false;
                    feedback = 'Now isolate x by dealing with its coefficient';
                }
            } else {
                isCorrect = false;
                feedback = 'This equation should only take 2 steps';
            }
            
            if (isCorrect) {
                stepDiv.classList.add('completed');
                stepDiv.innerHTML += '<span style="color: var(--success-green); margin-left: 10px;">✓</span>';
                
                if (steps.length === 2) {
                    // Both steps completed correctly
                    setTimeout(() => {
                        showFeedback('🎉 Great! You solved it step by step! Now enter your final answer.', 'success');
                    }, 500);
                }
            } else {
                stepDiv.classList.add('error');
                stepDiv.innerHTML += `<span style="color: var(--danger-red); margin-left: 10px;">✗ ${feedback}</span>`;
            }
        }

        function showProblemHint(difficulty, index) {
            const equation = worksheetProblems[difficulty][index].equation;
            let hint = '';
            
            if (equation.includes('+') && equation.includes('x')) {
                hint = 'First subtract the constant term, then divide by the coefficient of x.';
            } else if (equation.includes('-') && equation.includes('x')) {
                hint = 'First add to remove the negative term, then divide by the coefficient of x.';
            } else if (equation.includes('÷')) {
                hint = 'First subtract/add the constant term, then multiply to clear the division.';
            }
            
            showFeedback(`💡 Hint: ${hint}`, 'info');
        }

        function checkWorksheetAnswer(difficulty, index) {
            const problem = worksheetProblems[difficulty][index];
            const userAnswer = parseInt(document.getElementById(`answer-${difficulty}-${index}`).value);
            const feedback = document.getElementById(`feedback-${difficulty}-${index}`);
            const attemptsSpan = document.getElementById(`attempts-${difficulty}-${index}`);
            
            const key = `${difficulty}-${index}`;
            if (!problemAttempts[key]) {
                problemAttempts[key] = 0;
            }
            
            problemAttempts[key]++;
            attemptsSpan.textContent = problemAttempts[key];
            
            if (userAnswer === problem.answer) {
                feedback.style.display = 'block';
                feedback.style.padding = '15px';
                feedback.style.background = '#e8f5e9';
                feedback.style.borderRadius = '8px';
                feedback.style.color = '#2e7d32';
                feedback.innerHTML = '<strong>🎉 Correct!</strong> Excellent work solving this two-step equation!';
                
                // Calculate XP based on attempts
                let earnedXP = problem.xp;
                if (problemAttempts[key] > 1) {
                    earnedXP = Math.max(Math.round(problem.xp * (1 - (problemAttempts[key] - 1) * 0.2)), 5);
                }
                
                addXP(earnedXP);
                problemsCompleted++;
                updateProgress();
                
                // Disable input and style the card
                document.getElementById(`answer-${difficulty}-${index}`).disabled = true;
                const problemCard = document.getElementById(`answer-${difficulty}-${index}`).closest('.problem-card');
                problemCard.style.background = '#e8f5e9';
                problemCard.style.borderLeft = '4px solid var(--success-green)';
                
                // Show verification
                const balanceInfo = problemCard.querySelector('.balance-info small');
                balanceInfo.innerHTML = `✅ When x = ${problem.answer}, both sides are balanced! Perfect! ⚖️`;
            } else {
                feedback.style.display = 'block';
                feedback.style.padding = '15px';
                feedback.style.background = '#ffebee';
                feedback.style.borderRadius = '8px';
                feedback.style.color = '#c62828';
                let hint = '';
                if (userAnswer > problem.answer) {
                    hint = 'Your answer is too high.';
                } else {
                    hint = 'Your answer is too low.';
                }
                feedback.innerHTML = `<strong>Not quite.</strong> ${hint} Try working through the steps again!`;
            }
        }

        function addXP(amount) {
            currentXP += amount;
            document.getElementById('xp-value').textContent = currentXP;
            
            const xpDisplay = document.getElementById('xp-display');
            xpDisplay.classList.add('pulse');
            setTimeout(() => {
                xpDisplay.classList.remove('pulse');
            }, 500);
            
            if (currentXP >= 200 && currentXP - amount < 200) {
                showAchievement('🏆 Two-Step Master! 200 XP earned!');
            } else if (currentXP >= 400 && currentXP - amount < 400) {
                showAchievement('🌟 Equation Expert! 400 XP earned!');
            }
        }

        function showAchievement(message) {
            const achievement = document.createElement('div');
            achievement.className = 'achievement';
            achievement.textContent = message;
            document.body.appendChild(achievement);
            
            setTimeout(() => {
                achievement.remove();
            }, 3500);
        }

        function updateProgress() {
            const percentage = (problemsCompleted / totalProblems) * 100;
            document.getElementById('progress-bar').style.width = percentage + '%';
            updateProgressDisplay();
            
            if (problemsCompleted === totalProblems) {
                showAchievement('🎊 All Problems Complete! Amazing job!');
            }
        }

        function updateProgressDisplay() {
            document.getElementById('progress-text').textContent = 
                `${problemsCompleted} of ${totalProblems} problems completed`;
        }

        function showFeedback(message, type) {
            // Create a temporary feedback element
            const feedback = document.createElement('div');
            feedback.style.cssText = `
                position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                padding: 15px 25px; border-radius: 8px; font-weight: bold;
                z-index: 1000; animation: fadeIn 0.3s ease;
                ${type === 'success' ? 'background: #e8f5e9; color: #2e7d32;' : 'background: #ffebee; color: #c62828;'}
            `;
            feedback.textContent = message;
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                feedback.remove();
            }, 3000);
        }

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && document.activeElement.type === 'number') {
                const id = document.activeElement.id;
                if (id.includes('answer-')) {
                    const parts = id.split('-');
                    checkWorksheetAnswer(parts[1], parseInt(parts[2]));
                }
            }
        });
    </script>
</body>
</html>